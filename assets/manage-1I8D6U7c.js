import{a as X}from"./Icon.vue_vue_type_script_setup_true_lang-B_bz3tPt.js";import{C as B,A as L}from"./index-Bf9NpXkZ.js";import{_ as Y,g as Z}from"./file-operate-button-list.vue_vue_type_script_setup_true_lang-DCGcjeHG.js";import{_ as ee}from"./file-preview-drawer.vue_vue_type_script_setup_true_lang-BFb7Onlx.js";import{f as ae,p as te}from"./index-DKcumURF.js";import{f as ne}from"./dateUtil-ohqk8BGA.js";import{r as i,b as F,bS as f,k as l,ak as le,d as se,n as oe,w as ie,o as ue,I as d,J as R,K as o,B as n,_ as z,Q as $,U as re,F as me,j as ce,S as A,a8 as fe,b0 as E,cA as pe,a$ as I,cB as x,bb as de}from"./vendor-D7Y6X7_h.js";import"./index.vue_vue_type_style_index_0_lang-reX62h1K.js";import{u as ve}from"./useFormModal-DrjhP41g.js";import{c as he}from"./createContextMenu-BYsesM0V.js";import{u as ge}from"./dynamic-table-CtWW4hiU.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-BrXY2i5o.js";import"./file-upload-drawer.vue_vue_type_script_setup_true_lang-0qWrqVFo.js";import"./is-CBsgbGQ7.js";import"./useModal-p6LRjO4c.js";import"./schema-form.vue_vue_type_script_setup_true_lang-BWF4-paj.js";import"./index-DaE14gLf.js";const ye=m=>m?ae(m):"-",ke=()=>{const m=i([]),v=i(""),k=F(()=>!f(v.value)),_=F(()=>[{title:"文件名",dataIndex:"name",align:"left"},{title:"大小",width:120,align:"center",dataIndex:"fsize",customRender:({record:a})=>l("span",null,[ye(a.fsize)])},{title:"上传时间",dataIndex:"putTime",align:"center",width:220,customRender({text:a}){return ne(a)}},{title:"所属目录",dataIndex:"belongTo",align:"center",width:220,hideInTable:!k.value,customRender:({record:a})=>l(le("a-button"),{type:"link",disabled:a.type==="file"&&B("netdisk:manage:info"),onClick:()=>T(a)},{default:()=>[a.belongTo?a.belongTo:"根目录"]})}]),T=a=>{v.value="",f(a.belongTo)?m.value=[]:m.value=a.belongTo.split("/")};return{columns:_,currentPathList:m,localSearchKey:v,isSearching:k}},be=["innerHTML"],_e={key:1},ze=se({name:"NetDiskManage",__name:"manage",setup(m){const[v,k]=ge(),[_]=ve(),{columns:T,currentPathList:a,localSearchKey:r,isSearching:b}=ke(),C=i(),h=i([]),g=i(""),K=i(!1),w=i(!1),N=i(!1),p=i(!1),D=i([]),P=oe({selectedRowKeys:[],onChange:(e,t)=>{P.selectedRowKeys=e,D.value=t.map(c=>({type:c.type,name:c.name}))}}),O=F(()=>f(g.value)),y=()=>{let e="";return a.value.length>0&&(e=`${a.value.join("/")}/`),e},V=(e,t)=>t==="dir"?"file-type-dir":te(e),j=e=>e.replace(new RegExp(`${r.value}`,"g"),`<span style='color: red;'>${r.value}</span>`),H=e=>{K.value!==e&&(K.value=e)},M=()=>{g.value=" ",h.value=[],D.value=[],p.value&&(p.value=!1),S()},S=async()=>{if(p.value,p.value)return;w.value=!0,p.value=!0;const e=y(),t=await L.netDiskManage.netDiskManageList({path:e,key:r.value,marker:g.value?.trim()||""}).finally(()=>w.value=!1);if(f(g))h.value=t.list||[];else{const c=t.list.filter(u=>u.type==="file"?!0:!h.value.find(s=>s.type==="file"?!1:s.name===u.name));f(c)||h.value.push(...c)}g.value=t.marker,p.value=!1},U=e=>{b.value||(e===-1&&a.value.length>0?a.value=[]:e>=0&&a.value.length-1!==e&&(a.value=a.value.slice(0,e+1)))},J=e=>{if(e.type==="dir")if(b.value){const t=f(e.belongTo)?[]:e.belongTo.split("/");t.push(e.name),r.value="",a.value=t}else a.value.push(e.name);else b.value?C.value?.open(e.name,f(e.belongTo)?"":`${e.belongTo}/`):C.value?.open(e.name,y())},Q=async e=>{try{N.value=!0;const t=await L.netDiskManage.netDiskManageDownload({path:y(),name:e.name});window.open(`${t}?attname=${encodeURIComponent(e.name)}`)}finally{N.value=!1}},W=async e=>{await _({modalProps:{title:"重命名",width:700,onFinish:async t=>{await L.netDiskManage.netDiskManageRename({type:e.type,toName:t.toName,name:e.name,path:y()}),M()}},formProps:{labelWidth:100,schemas:Z(e)}})},q=e=>({onContextmenu:t=>{he({event:t,items:[{label:"下载",disabled:e.type==="dir"||!B("netdisk:manage:download"),handler:()=>{Q(e)}},{label:"重命名",disabled:!B("netdisk:manage:rename"),handler:()=>{W(e)}}]})}});return ie([a,r],()=>{M()},{deep:!0}),ue(()=>{S(),k.onInfiniteScroll(()=>{O.value||S()})}),(e,t)=>{const c=X;return d(),R(n(de),{class:"h-full"},{title:o(()=>[l(n(E),null,{default:o(()=>[l(n(pe)),l(n(I),null,{default:o(()=>[l(n(I).Item,null,{default:o(()=>[l(n(x).Link,{onClick:t[0]||(t[0]=u=>U(-1))},{default:o(()=>[z("根目录")]),_:1})]),_:1}),(d(!0),$(me,null,re(n(a),(u,s)=>(d(),R(n(I).Item,{key:s},{default:o(()=>[l(n(x).Link,{onClick:G=>U(s)},{default:o(()=>[z(A(u),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1})]),extra:o(()=>[l(Y,{"search-key":n(r),"onUpdate:searchKey":t[1]||(t[1]=u=>ce(r)?r.value=u:null),"selected-file-list":D.value,"update-operate-status":H,"parse-path":y,onChanged:M},null,8,["search-key","selected-file-list"])]),default:o(()=>[l(n(v),{"data-source":h.value,columns:n(T),"custom-row":q,"auto-height":!0,pagination:!1,search:!1,"show-tool-bar":!1,loading:w.value,"row-selection":P},{bodyCell:o(({column:u,record:s})=>[u.key==="name"?(d(),R(n(x).Link,{key:0,disabled:s.type==="file"&&e.$auth("netdisk:manage:info"),onClick:G=>J(s)},{default:o(()=>[l(n(E),null,{default:o(()=>[l(c,{name:V(s.name,s.type)},null,8,["name"]),n(b)?(d(),$("span",{key:0,innerHTML:j(s.name)},null,8,be)):(d(),$("span",_e,A(s.name),1))]),_:2},1024)]),_:2},1032,["disabled","onClick"])):fe("",!0)]),_:1},8,["data-source","columns","loading","row-selection"]),l(ee,{ref_key:"previewDrawerRef",ref:C},null,512)]),_:1})}}});export{ze as default};
